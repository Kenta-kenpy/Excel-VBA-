'行ごと、列ごと　結合
'データが入っているセルのうち最も後ろのセルに格納されたデータは、行単位で見たとき何列目まで、列単位で見たとき何行目まで、使われているか。

Private Const MAX_COL As Long = 100  '列　タテ方向のセル　右へ 仮に20
Private Const MAX_ROW As Long = 100 '行　ヨコ方向のセル　下へ 仮に22

Sub Cell_count()
    MsgBox ("データが格納されたセルの末尾の" & vbCrLf & "列番号・行番号をお知らせ") 'vbCrLfはメッセージボックスの改行
    '★ヨコ方向のセルについて　末尾データの列の場所を求める
    MsgBox ("※セルを右に向かって見ています")
    MsgBox ("行の使用済みセル最大列番号を求めます")
    '*** データのあるセル範囲取得 開始*** ●
    ' シート名
    Dim csvSh As Worksheet
    Set csvSh = ThisWorkbook.Worksheets("Sheet14")  'シート番号
    
    ' 行ごとのデータ数を格納する配列dataCountを初期化 *** ●●
    Dim dataCount() As Long
    '配列サイズを確定
    ReDim dataCount(1 To MAX_ROW) As Long
    
    ' 配列のループ
    ' 行の数 i
    Dim i As Long
    ' 1行から順にデータ数をカウント
    For i = 1 To MAX_ROW
        ' 各行の最終列を取得
        Dim lastCol As Long
        lastCol = csvSh.Cells(i, csvSh.Columns.Count).End(xlToLeft).column
        '*** 最終列を1と置く　これがないと先頭行データが空白のとき最終列として判断できない ***
        ' 先頭行データが設定されているかいないか
        If lastCol = 1 And IsEmpty(csvSh.Cells(i, 1).Value) Then '最終列が便宜上1列目 かつ 先頭列データが空白
            dataCount(i) = 0  '行のデータ数0とする
        Else
            ' データ数をカウント
            dataCount(i) = lastCol
        End If
    Next i
    
    '上記で作成した配列dataCountの中に格納されているデータの最大値を求める！ *** ●●●
    Dim max_retu As Long
    '「各行の使用済みセル列の末尾列」のセルに格納されている値の配列
    'step1 配列の先頭要素を最大値の初期値とする
    max_retu = dataCount(1)
    'step2 配列ループ
    'For i = 0 To (UBound(dataCount) - LBound(dataCount)) '配列の最大インデックス-配列の最小インデックス+1　これで配列要素数が求まる
    For i = LBound(dataCount) To UBound(dataCount)
        'step3 要素大小比較
        If dataCount(i) > max_retu Then
            'step4 配列の隣接2要素について　左の要素が右の要素より大きければ入れ替えて最大値に代入
            max_retu = dataCount(i)
        End If
    Next i
    MsgBox ("データが入っているセルの使用する列番号最大値は" & vbCrLf & max_retu & " です")  'vbCrLfはメッセージボックスの改行
    
    '--------------------------------------------------------------------------------
    '★タテ方向のセルについて　末尾データの行の場所を求める
    MsgBox ("つづきまして　列の使用済みセル最大行番号を求めます")
    MsgBox ("※セルを下に向かって見ています")
    '*** データのあるセル範囲取得 開始*** ●
    ' 列ごとのデータ数を格納する配列dataCountを再初期化 *** ●●
    '配列サイズを確定
    ReDim dataCount(1 To MAX_COL) As Long
    
    '配列のループ
    ' 列の数 j
    Dim j As Long
    ' 1列から順にデータ数をカウント
    For j = 1 To MAX_COL
        ' 各列の最終行を取得
        Dim lastRow As Long
        lastRow = csvSh.Cells(csvSh.Rows.Count, j).End(xlUp).Row
        '*** 最終行を1と置く　これがないと先頭列データが空白のとき最終行として判断できない ***
        ' 先頭列データが設定されているかいないか
        If lastRow = 1 And IsEmpty(csvSh.Cells(1, j).Value) Then '最終行が便宜上1行目 かつ 先頭行データが空白
            dataCount(j) = 0  '列のデータ数0とする
        Else
            ' データ数をカウント
            dataCount(j) = lastRow
        End If
    Next j
    
    '上記で作成した配列dataCountの中に格納されているデータの最大値を求める！ *** ●●●
    Dim max_gyou As Long
    '「各列の使用済みセル行の末尾行」のセルに格納されている値の配列
    'step1 配列の先頭要素を最大値の初期値とする
    max_gyou = dataCount(1)
    'step2 配列ループ
    'For j = 0 To (UBound(dataCount) - LBound(dataCount)) '配列の最大インデックス-配列の最小インデックス+1　これで配列要素数が求まる
    For j = LBound(dataCount) To UBound(dataCount)
        'step3 要素大小比較
        If dataCount(j) > max_gyou Then
            'step4 配列の隣接2要素について　左の要素が右の要素より大きければ入れ替えて最大値に代入
            max_gyou = dataCount(j)
        End If
    Next j
    MsgBox ("データが入っているセルの使用する行番号最大値は" & vbCrLf & max_gyou & " です") 'vbCrLfはメッセージボックスの改行
    
    '--------------------------------------------------------------------------------
    MsgBox ("シートCSV変換を開始します")
    '*** 書き込み工程 開始*** ◆◆◆
    Dim csvVal As String 'セル座標のデータをcsvValとして取得
    '使用済み行rowの数の取得　最大値1048576行から上の範囲
    'lastRow = csvSh.Cells(csvSh.Rows.Count, 1).End(xlUp).Row
    '使用済み列columnの数16384の取得 最大値XFD列から左の範囲
    'lastCol = csvSh.Cells(1, csvSh.Columns.Count).End(xlToLeft).column

     ' CSVファイルの保存先を指定
    Dim outputFile As String
    outputFile = "C:\Users\NEC-PCuser\Desktop\CSVFile.csv" '任意のディレクトリに変更

    ' 空ファイル番号を取得
    Dim csvNum As Long
    csvNum = FreeFile

    ' CSVファイルを書き込みモードで開く
    Open outputFile For Output As #csvNum
    ' 行方向要素数分ループ
    For i = 1 To max_gyou
        ' 列方向要素数分ループ
        For j = 1 To max_retu
            ' セルの値を配列から定義
            csvVal = csvSh.Cells(i, j).Value
            ' セルが空でない場合に値を書き込む
            If j = max_retu Then
                ' 最終列の場合、デフォルトで改行コードが付与
                Print #csvNum, csvVal
            Else
                ' 最終列でない場合、コンマ刻みで末尾にセミコロン付与
                Print #csvNum, csvVal & ",";
            End If
        Next j
    Next i

    ' ファイルを閉じる
    Close #csvNum

    MsgBox ("シートCSV変換 出力完了しました")
    '*** 書き込み工程 終了*** ◆◆◆
    
End Sub
